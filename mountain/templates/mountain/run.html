{% extends "base.html" %}

{% load static %}

{% block content %}
  <script>
    // We define the image source, and restart button, here as the URLs are going to be generated by Django template
    image_scr = "{% static request.path %}/{{ room_name }}/step.jpg";
    restart_button = '<a href="/{{ app_folder }}/run" class="btn btn-info"><i class="bi bi-bootstrap-reboot"></i> Restart</a>';
  
    ws_setting = "{{ ws_setting }}";
  </script>

  <!-- Add React and ReactDOM -->
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  
  <!-- Load our components first -->
  <script src="{% static app_folder %}/js/mobileControl.js"></script>
  
  <!-- Then load game scripts -->
  <script src="{% static app_folder %}/js/script.js"></script>
  <script src="{% static app_folder %}/js/keyPressDisplay.js"></script>

  <style>
    @media (max-width: 768px) {
      .controls-card, .key-press-display {
        display: none;
      }
      .game-container {
        width: 100% !important;
        padding: 0 10px;
      }
      .container {
        padding: 0;
      }
      .row {
        margin: 0;
      }
    }
  </style>

  <section class="text-center">
    <div class="container">
      <br>
      <h2 class="text-start"><a href="/{{ app_folder }}/config" class="btn btn-info"><i class="bi bi-arrow-left"></i> Config</a></h2>
      <h1>{{ app_name }} - room <i>{{ room_name }}</i></h1>
      <h2 id="sub-title">Step 0</h2>
    </div>
  </section>

  <br>
  <div class="container">
    <div id="loading_div" class="d-flex align-items-left justify-content-center">
      <strong>Your game is loading...</strong> &nbsp;&nbsp;&nbsp;
      <div class="spinner-border ml-auto" role="status" aria-hidden="true"></div>
    </div>

    <div class="row mt-3">
      <div class="col-md-8 d-flex justify-content-center">
        <div class="game-container" style="width: 78%;">
          <img id="image" style="visibility: hidden;" class="img-fluid rounded img-thumbnail w-100" src="{% static request.path %}/{{ room_name }}/step.jpg">
          {% include "mountain/components/key_press_display.html" %}
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card border-secondary controls-card">
          <div class="card-header bg-light">
            <h5 class="card-title mb-0">Controls</h5>
          </div>
          <div class="card-body">
            <p class="card-text">Use the following keys to control the car:</p>
            <div class="d-flex justify-content-around mb-3">
              <div class="text-center">
                <kbd class="keyboard-key">←</kbd>
                <div>Left</div>
              </div>
              <div class="text-center">
                <kbd class="keyboard-key">→</kbd>
                <div>Right</div>
              </div>
            </div>
            <p class="card-text">These keys will override the agent's actions.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Controls Container -->
  <div id="mobile-controls-root"></div>

  <script>
    // Wait for all scripts to load
    window.addEventListener('load', function() {
      function isMobileDevice() {
        return (window.innerWidth <= 768) || ('ontouchstart' in window);
      }

      function MobileControlsWrapper() {
        if (isMobileDevice()) {
          return React.createElement(MobileControls, {
            onLeftPress: () => document.dispatchEvent(new KeyboardEvent('keydown', { key: 'ArrowLeft' })),
            onRightPress: () => document.dispatchEvent(new KeyboardEvent('keydown', { key: 'ArrowRight' }))
          });
        }
        return null;
      }

      // Render mobile controls if on mobile device
      const rootElement = document.getElementById('mobile-controls-root');
      if (rootElement && window.MobileControls) {
        ReactDOM.render(
          React.createElement(MobileControlsWrapper),
          rootElement
        );
      }
    });
  </script>
{% endblock %}